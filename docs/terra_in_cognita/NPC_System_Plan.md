# NPC 시스템 개선 계획: 절대세력 & 자유세력

## 1. 개요
본 문서는 "Terra In-cognita"의 NPC 시스템 개선을 위한 설계 및 구현 계획을 기술합니다. 이 시스템은 비플레이어 세력을 크게 **절대세력 (City-States)**과 **자유세력 (Expansionists)** 두 가지 유형으로 구분합니다. 각 세력은 고유한 행동 패턴, 경제적 역할, 그리고 전략적 목표를 가집니다.

## 2. 세력 유형 정의

### 2.1. 절대세력 (The City-States)
*   **컨셉**: 주요 도시에 위치한, 이미 확고한 기반을 다진 기술 선진국입니다. 이들은 질서, 고차원 상업, 그리고 안정을 대변합니다.
*   **주요 목표**: 경제적 지배, 기술 발전, 서비스 제공. 이들의 목표는 거대한 "도시 국가"를 유지하는 것입니다.
*   **행동 루프**:
    1.  **소비 (Consume)**: 글로벌 시장에서 1차 자원(광석, 목재, 식량)을 공격적으로 매입합니다 (수요 유지).
    2.  **생산 (Produce)**: 원자재를 가공하여 고티어 물품(합금, 회로) 및 장비(무기, 방어구, 차량)를 생산합니다.
    3.  **서비스 (Service)**: 유저에게 특수 서비스를 제공합니다 (예: 고이율 은행, 고급 수리, 용병 계약).
    4.  **방어 (Defense)**: 영토 내 방어력이 극도로 높습니다. 외부로 확장은 거의 하지 않으나, 국경을 철저히 방어합니다.

### 2.2. 자유세력 (The Wanderers & Warlords)
*   **컨셉**: 황무지에서 바닥부터 시작하는 신흥 세력, 반군, 또는 생존자 그룹입니다. 유저의 성장 과정과 유사한 행보를 보입니다.
*   **주요 목표**: 영토 확장, 자원 독점, 그리고 생존.
*   **행동 루프**:
    1.  **확장 (Expand)**: 빈 영토(자원 노드)를 능동적으로 탐색하고 점령합니다.
    2.  **채집 (Gather)**: 성장을 위해 1차/2nd 산업(채광, 농업)에 집중합니다.
    3.  **외교 (Diplomacy)**: 인접한 유저 및 다른 자유세력과 동적인 관계를 맺습니다.
        *   *동맹 (Alliance)*: 무역 협정, 불가침 조약.
        *   *전쟁 (War)*: 자원 노드 약탈, 영토 분쟁.
    4.  **기동성 (Agility)**: 위협을 받으면 본거지를 이동하거나 더 작은 하위 세력으로 분열할 수 있습니다.

## 3. 구현 상세

### 3.1. 데이터베이스 스키마 확장
기존 `users` 테이블을 확장하거나 상태 추적을 위한 새로운 테이블이 필요합니다.

#### `users` 테이블 업데이트
*   기존 `npc_type` 컬럼 값: `'NONE'` (유저), `'ABSOLUTE'` (절대세력), `'FREE'` (자유세력).
*   추가 필요 컬럼 (또는 별도의 `npc_profiles` 테이블):
    *   `personality`: (공격적, 방어적, 상업적, 외교적)
    *   `tech_focus`: (군사, 산업, 생명공학)
    *   `diplomatic_stance`: 관계를 저장하는 JSON 문자열 `{ "user_1": -50 (적대), "user_2": 80 (우호) }`

#### `npc_decisions` / `npc_memory` (신규 아이디어)
*   NPC가 살아있는 것처럼 느껴지게 하려면 등 과거 상호작용에 대한 기억이 필요합니다 (예: "어제 날 공격했으니 오늘은 거래 안 해").

### 3.2. 서버 사이드 로직 ("The Brain")

#### 절대세력 로직 (`AbsoluteNpcManager.js`)
*   **시장 메이커**: 매시간 글로벌 시장 가격을 확인. 광석이 저렴하면 대량 매수.
*   **공장**: 인벤토리 자원을 완제품으로 변환. 프리미엄을 붙여 시장에 판매.
*   **퀘스트 발주**: 유저 대상 퀘스트 생성 (예: "철광석 1000개를 가져오면 시세보다 비싸게 사겠다").

#### 자유세력 로직 (`FreeNpcManager.js`)
*   **스캐너**: 반경 `x, y` 내의 이웃 탐색.
*   **확장**: 이웃 타일이 비어 있고 자원이 있다면 -> 전초기지 건설.
*   **전투**: 이웃이 유저라면 -> `diplomatic_stance` + 상대적 전력 확인.
    *   적대적 && 우리가 더 강함 -> 공격.
    *   적대적 && 우리가 더 약함 -> 방어 강화 또는 공물 제공 (평화 조약).

### 3.3. 기술적 로드맵
1.  **스키마 개선**: NPC 성격 및 외교를 위한 DB 변경 확정.
2.  **세력 시드(Seed) 생성**: 1~2개의 절대세력(예: "아이언 코어 인더스트리")과 유저 시작 지점 근처에 3~5개의 자유세력 생성.
3.  **절대세력 루프 구현**: 시장 상호작용 우선 구현 (경제 밸런스).
4.  **자유세력 루프 구현**: 이동/건설 우선 구현 (지도 압박).
6.  **외교 UI**: 유저가 세력 평판을 확인하고 상호작용(무역/전쟁)할 수 있는 방법 추가.

### 3.4. 외교 메커니즘 (Diplomacy Mechanics)
*   **이동 제한 (Movement Restrictions)**:
    *   기본적으로 중립 영토는 통과 가능.
    *   **적대(Hostile)** 관계이거나 **접근 불가(Closed)** 상태인 세력의 영토에는 진입할 수 없습니다.
    *   위반 시도 시 경고 메시지 출력 및 이동 취소.
*   **건설 승인 (Construction Permissions)**:
    *   타인의 영토에는 기본적으로 건설 불가.
    *   **동맹(Alliance)** 또는 **연합(Coalition)** 관계인 경우 건설 **요청(Request)** 가능.
    *   영토 소유주가 요청을 **승인(Approve)**해야 건설이 시작됩니다.
    *   승인 대기 중인 건물은 '건설 예정지' 상태로 표시됩니다.

## 4. 진행 상황 (Progress)

### 4.1. 백엔드 구현 (완료)
- [x] **스키마 확장**: `users` 테이블에 NPC 속성 추가, `npc_memory` 테이블 생성 완료.
- [x] **세력 로직**:
    - `AbsoluteNpcManager`: 시장 가격 스캔 및 자원 매입 로직 구현.
    - `FreeNpcManager`: 인접 타일 스캔, 확장(전초기지) 및 **영토 내 자원 개발(광산/농장)** 로직 구현.
    - 서버 루프(1분 간격)에 AI 매니저 통합 완료.
- [x] **데이터 시딩**:
    - 절대세력 7개 및 각 수도(City) 생성 완료 (서울, 도쿄 등).
    - 자유세력 3개 및 무작위 전초기지 생성 완료.

### 4.2. 프론트엔드 구현 (완료)
- [x] **지도 시각화**:
    - 절대세력: 고유 색상 및 경계선(Polygon) 표시.
    - 자유세력: 고유 색상 및 원형 경계 표시.
- [x] **외교 UI**:
    - 세력 목록 및 상세 정보(성향, 우호도) 확인 패널 구현.
